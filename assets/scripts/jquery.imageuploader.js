(function(a){a.fn.uploader=function(b,c){return this.each(function(j){b=a.extend({submitButtonCopy:"上传选定的文件",instructionsCopy:"支持拖放",furtherInstructionsCopy:"你也可以删除文件",selectButtonCopy:"选择文件",secondarySelectButtonCopy:"选择多个文件",dropZone:a(this),fileTypeWhiteList:["jpg","png","jpeg","gif","pdf"],badFileTypeMessage:"对不起，我们不能接受这种类型的文件。",ajaxUrl:"/ajax/upload",testMode:false},b);var p={fileBatch:[],isUploading:false,isOverLimit:false,listIndex:0};var g={uploaderBox:a(this),submitButton:a('<button class="js-uploader__submit-button uploader__submit-button uploader__hide">'+b.submitButtonCopy+'<i class="js-uploader__icon fa fa-upload uploader__icon"></i></button>'),instructions:a('<p class="js-uploader__instructions uploader__instructions">'+b.instructionsCopy+"</p>"),selectButton:a('<input style="height: 0; width: 0;" id="fileinput'+j+'" type="file" multiple class="js-uploader__file-input uploader__file-input"><label for="fileinput'+j+'" style="cursor: pointer;" class="js-uploader__file-label uploader__file-label">'+b.selectButtonCopy+"</label>"),secondarySelectButton:a('<input style="height: 0; width: 0;" id="secondaryfileinput'+j+'" type="file" multiple class="js-uploader__file-input uploader__file-input"><label for="secondaryfileinput'+j+'" style="cursor: pointer;" class="js-uploader__file-label uploader__file-label uploader__file-label--secondary">'+b.secondarySelectButtonCopy+"</label>"),fileList:a('<ul class="js-uploader__file-list uploader__file-list"></ul>'),contentsContainer:a('<div class="js-uploader__contents uploader__contents"></div>'),furtherInstructions:a('<p class="js-uploader__further-instructions uploader__further-instructions uploader__hide">'+b.furtherInstructionsCopy+"</p>")};g.uploaderBox.empty();o(g);e();function o(r){r.contentsContainer.append(r.instructions).append(r.selectButton);r.furtherInstructions.append(r.secondarySelectButton);r.uploaderBox.append(r.fileList).append(r.contentsContainer).append(r.submitButton).after(r.furtherInstructions)}function e(){b.dropZone.on("dragover dragleave",function(r){r.preventDefault();r.stopPropagation()});a.event.props.push("dataTransfer");b.dropZone.on("drop",n);g.selectButton.on("click",function(){this.value=null});g.selectButton.on("change",n);g.secondarySelectButton.on("click",function(){this.value=null});g.secondarySelectButton.on("change",n);g.submitButton.on("click",q);g.uploaderBox.on("click",".js-upload-remove-button",l);if(b.testMode){b.dropZone.on("uploaderTestEvent",function(r){switch(r.functionName){case"selectFilesHandler":n(r);break;case"uploadSubmitHandler":q(r);break;default:break}})}}function d(r){var s=f(r.name);var u=r.size;var v=p.listIndex;var z;var t=a('<span class="uploader__file-list__text">'+s+"</span>");p.listIndex++;var w=a('<li class="uploader__file-list__item" data-index="'+v+'"></li>');var B=a('<span class="uploader__file-list__thumbnail"></span>');var A=a('<img class="thumbnail"><i class="fa fa-spinner fa-spin uploader__icon--spinner"></i>');var y=a('<span class="uploader__file-list__button"><button class="uploader__icon-button js-upload-remove-button fa fa-times" data-index="'+v+'"></button></span>');if(b.fileTypeWhiteList.indexOf(i(r.name).toLowerCase())!==-1){p.fileBatch.push({file:r,id:v,fileName:s,fileSize:u});z=a('<span class="uploader__file-list__size">'+h(u)+"</span>")}else{z=a('<span class="uploader__file-list__size"><span class="uploader__error">'+b.badFileTypeMessage+"</span></span>")}if(window.FileReader&&r.type.indexOf("image")!==-1){var x=new FileReader();x.onloadend=function(){A.attr("src",x.result);A.parent().find("i").remove()};x.onerror=function(){A.remove()};x.readAsDataURL(r)}else{if(r.type.indexOf("image")===-1){A=a('<i class="fa fa-file-o uploader__icon">')}}B.append(A);w.append(B);w.append(t).append(z).append(y);g.fileList.append(w)}function i(s){var r=s.split(/[\\/]/).pop();var t=r.lastIndexOf(".");if(r===""||t<1){return""}return r.slice(t+1)}function h(r,s){if(r===0){return"0 Bytes"}var v=1024;var t=s+1||3;var w=["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"];var u=Math.floor(Math.log(r)/Math.log(v));return(r/Math.pow(v,u)).toPrecision(t)+" "+w[u]}function f(r){r=r.replace(/\s+/gi,"-");return r.replace(/[^a-zA-Z0-9.\-]/gi,"")}function q(){if(p.fileBatch.length!==0){var r=new FormData();for(var s=0;s<p.fileBatch.length;s++){r.append("files[]",p.fileBatch[s].file,p.fileBatch[s].fileName)}a.ajax({type:"POST",url:b.ajaxUrl,data:r,cache:false,contentType:false,processData:false})}}function n(r){r.preventDefault();r.stopPropagation();if(!p.isUploading){var s=r.target.files||r.dataTransfer.files||r.dataTransfer.getData;for(var t=0;t<s.length;t++){d(s[t])}}m()}function m(){if(g.fileList.children().size()!==0){g.submitButton.removeClass("uploader__hide");g.furtherInstructions.removeClass("uploader__hide");g.contentsContainer.addClass("uploader__hide")}else{g.submitButton.addClass("uploader__hide");g.furtherInstructions.addClass("uploader__hide");g.contentsContainer.removeClass("uploader__hide")}}function l(r){r.preventDefault();if(!p.isUploading){var s=a(r.target).data("index");k(s);a(r.target).parent().remove()}m()}function k(s){for(var r=0;r<p.fileBatch.length;r++){if(p.fileBatch[r].id===parseInt(s)){p.fileBatch.splice(r,1);break}}g.fileList.find('li[data-index="'+s+'"]').remove()}})}}(jQuery));